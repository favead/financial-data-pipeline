# Financial assistant RAG data pipeline

В этом проекте собран весь пайплайн парсинга, обработки и подготовки данных для финансового ассистента

## Пояснительная записка

### 1. Сбор данных
- Реализован сбор данных из трех основных источников:
  1. Курсы от БКС (`collect/bcs.py`)
     - Использует API БКС для получения списка курсов
     - Парсит HTML-страницы с контентом курсов
     - Требует авторизационные куки для доступа
  2. Курсы от Тинькофф (`collect/tinkoff.py`)
     - Парсит страницы с курсами по финансовой грамотности
     - Извлекает контент из HTML-структуры
  3. PDF-учебники (`preprocessing/pdf2txt.py`)
     - Конвертирует PDF файлы в текстовый формат
     - Использует библиотеку pymupdf4llm для сохранения структуры документа

### 2. Предобработка данных
Реализован многоэтапный процесс очистки и подготовки данных:
1. Конвертация форматов (`html2txt.py`, `pdf2txt.py`)
   - HTML -> Markdown
   - PDF -> Markdown
2. Очистка текста (`clear_txt.py`)
   - Удаление технических элементов
   - Нормализация форматирования
   - Конфигурируемые паттерны очистки для каждого источника
3. Разбиение на чанки (`split.py`)
   - Использование MarkdownHeaderTextSplitter для сохранения структуры
   - Рекурсивное разбиение на чанки оптимального размера
4. Индексация (`index.py`)
   - Создание эмбеддингов с помощью multilingual-e5-small
   - Сохранение в FAISS для эффективного поиска

### 3. Исследовательский анализ данных
Реализован в модуле `evaluate/eda.py`:
- Анализ токенов, предложений и слов
- Подсчет частотности слов
- Визуализация распределений в дашборде
- Сохранение метрик в БД для мониторинга

### 4. Метрики качества данных
Реализованы в `evaluate/data_quality.py`:
1. Текстовые метрики:
   - Количество символов/слов/строк
   - Средняя длина слов
   - Соотношение пустых строк
2. Структурные метрики:
   - Анализ заголовков
   - Проверка форматирования
3. Метрики качества:
   - Дубликаты строк
   - Декоративные элементы
   - Аномально короткие/длинные строки

### 5. База данных
Использована MongoDB для хранения:
- Сырых документов
- Обработанных документов
- Чанков с метаданными
- Метрик качества и EDA
- Конфигураций очистки

Реализовано через единый интерфейс `storages.py` с классами для каждого типа данных.

### 6. Автоматизация пайплайна
Реализована в `main.py`:
1. Сбор данных:
   ```python
   collect_data()  # парсинг курсов
   ```
2. Трансформация:
   ```python
   transform_data()  # конвертация форматов
   ```
3. Обработка:
   ```python
   process_data()  # очистка и разбиение
   ```
4. Метрики:
   ```python
   collect_metrics()  # сбор метрик качества
   ```
5. Индексация:
   ```python
   index_chunks()  # создание векторного индекса
   ```

### 7. Дашборд
Реализован на Streamlit (`vizualize/dashboard.py`):
1. Основные метрики:
   - Общее количество документов
   - Средние показатели по токенам/предложениям
2. Детальный анализ:
   - Распределение токенов по источникам
   - Распределение предложений
   - Тепловая карта по времени
3. Фильтры:
   - По источникам данных
   - По временному диапазону
4. Интерактивные графики на Plotly
5. Детальная таблица с метриками


## База Знаний

Скачать файловое хранилище эмбеддингов можно с гугл диска по ссылке: https://drive.google.com/file/d/1ZJpODxrIUufjtp1993AEv5vnhhjtVp_3/view?usp=sharing

### Состав

1. Учебники по экономике:
    - Financial Markets and Institutions 7th ed. Frederic S. Mishkin, Stanley G. Eakins
    - Principles of macroeconomics 3th ed. David Shapiro, Daniel MacDonald, Steven A. Greenlaw
    - Principles of microeconomics 3th ed. David Shapiro, Daniel MacDonald, Steven A. Greenlaw
    - Principles of economics 3th ed. David Shapiro, Daniel MacDonald, Steven A. Greenlaw
    - Principles of Finance. Julie Danhlquist, Rainford Knight
    - Capital Markets And Securities Laws.
    - Securities Trading: Principles and Procedures. Joel Hasbrouck
    - Также набор учебников на русском языке. Позже инфомрация будет обновлена
2. Курсов по финансовой грамотности от bcs и tinkoff
3. Кодексов РФ

### Важные нюансы

#### БКС
У bcs на данный момент нет хорошо поддерживаемого api, поэтому перед запуском парсинга необходимо зайти на сайт и скопировать свои куки и заголовки, чтобы не получить блокировку по ip.

#### Кодексы
Кодексы получены с помощью парсинга сайта консультант плюс и в данном модуле исопльзуются как готовые json документы

#### Учебники
На данный момент очистка учебников требует ручного конфигурирования

### Добавление источников

#### Размещение учебников
Для этого в корень проекта необходимо добавить директорию `data/pdf_textbooks`, где в каждой поддиректории будут лежать учебники, которые необходимо предобработать.

#### Обработка
Далее запускайте 
```
python -m "financial_data.main"
```

И отработает пайплайн по предобработке, очистке, сплиту и индексации ваших учебников.

Пока что конфигурирование недоступно, но позже будет добавлено.